<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>VitalSense AI â€” Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet"/>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;700&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#080d14;--surface:#0e1724;--card:#121e2e;--border:#1e3354;
  --cyan:#00d4ff;--green:#00ff9d;--danger:#ff4560;--warn:#ffb800;
  --text:#cde4f5;--muted:#4a6a8a;
  --mono:'Space Mono',monospace;--body:'DM Sans',sans-serif;
}
html,body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--body);}
/* â”€â”€ Sidebar â”€â”€ */
.layout{display:flex;min-height:100vh;}
.sidebar{width:220px;flex-shrink:0;background:linear-gradient(180deg,#060c14,#0a1828);
  border-right:1px solid var(--border);padding:1.5rem 1rem;
  display:flex;flex-direction:column;gap:.5rem;}
.sidebar-logo{font-family:var(--mono);font-size:1rem;font-weight:700;
  background:linear-gradient(90deg,var(--cyan),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border);}
.sidebar-label{font-family:var(--mono);font-size:.58rem;letter-spacing:.16em;
  color:var(--cyan);text-transform:uppercase;margin-bottom:.5rem;margin-top:1rem;}
.nav-btn{display:block;width:100%;text-align:left;background:transparent;
  border:1px solid transparent;border-radius:8px;padding:.6rem .9rem;cursor:pointer;
  font-family:var(--mono);font-size:.65rem;letter-spacing:.08em;color:var(--muted);
  transition:all .2s;text-decoration:none;}
.nav-btn:hover,.nav-btn.active{background:var(--card);border-color:var(--border);color:var(--cyan);}
.status-box{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:.9rem;margin-top:auto;font-family:var(--mono);font-size:.55rem;
  color:var(--muted);line-height:1.9;}
.status-box b{color:var(--cyan);display:block;margin-bottom:.4rem;}
.s-ok{color:var(--green);}
.back-btn{display:block;text-align:center;margin-top:1rem;
  font-family:var(--mono);font-size:.6rem;letter-spacing:.12em;
  color:var(--muted);text-decoration:none;padding:.5rem;border-radius:6px;
  border:1px solid var(--border);transition:all .2s;}
.back-btn:hover{border-color:var(--cyan);color:var(--cyan);}
/* â”€â”€ Main â”€â”€ */
.main{flex:1;padding:1.8rem 2rem;overflow-y:auto;}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;
  margin-bottom:1.5rem;padding-bottom:1.2rem;border-bottom:1px solid var(--border);}
.page-title{font-family:var(--mono);font-size:1.8rem;font-weight:700;
  background:linear-gradient(90deg,var(--cyan),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.page-sub{font-family:var(--mono);font-size:.65rem;letter-spacing:.16em;
  color:var(--muted);text-transform:uppercase;margin-top:2px;}
.badge{display:inline-block;background:rgba(0,255,157,.12);color:var(--green);
  border:1px solid rgba(0,255,157,.3);border-radius:20px;padding:4px 14px;
  font-family:var(--mono);font-size:.62rem;letter-spacing:.1em;}
/* â”€â”€ Section head â”€â”€ */
.section-head{font-family:var(--mono);font-size:.62rem;letter-spacing:.2em;
  text-transform:uppercase;color:var(--cyan);border-left:3px solid var(--cyan);
  padding-left:10px;margin:1.5rem 0 1rem;}
/* â”€â”€ Cards â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:1.25rem 1.5rem;margin-bottom:1rem;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;
  background:linear-gradient(180deg,var(--cyan),transparent);}
.card-danger::before{background:linear-gradient(180deg,var(--danger),transparent);}
.card-warn::before  {background:linear-gradient(180deg,var(--warn),transparent);}
.card-ok::before    {background:linear-gradient(180deg,var(--green),transparent);}
/* â”€â”€ Grid â”€â”€ */
.grid-2{display:grid;grid-template-columns:3fr 2fr;gap:1.2rem;}
.grid-equal{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;}
/* â”€â”€ Metric â”€â”€ */
.metric-label{font-family:var(--mono);font-size:.58rem;letter-spacing:.12em;
  text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.metric-value{font-family:var(--mono);font-size:2rem;color:var(--cyan);font-weight:700;}
.metric-value.large{font-size:3rem;}
.metric-value.danger{color:var(--danger);}
.metric-value.warn{color:var(--warn);}
.metric-value.ok{color:var(--green);}
/* â”€â”€ Progress bar â”€â”€ */
.progress{background:#1e3354;border-radius:4px;height:6px;margin-top:8px;}
.progress-fill{height:6px;border-radius:4px;transition:width .4s;}
.fill-ok    {background:var(--green);}
.fill-warn  {background:var(--warn);}
.fill-danger{background:var(--danger);}
/* â”€â”€ Status pill â”€â”€ */
.pill{display:inline-block;border-radius:20px;padding:3px 14px;
  font-family:var(--mono);font-size:.65rem;letter-spacing:.1em;margin-top:10px;}
.pill-ok    {background:rgba(0,255,157,.12);color:var(--green);border:1px solid rgba(0,255,157,.3);}
.pill-warn  {background:rgba(255,184,0,.12) ;color:var(--warn) ;border:1px solid rgba(255,184,0,.3);}
.pill-danger{background:rgba(255,69,96,.12) ;color:var(--danger);border:1px solid rgba(255,69,96,.3);}
/* â”€â”€ Camera frame â”€â”€ */
.cam-wrap{font-family:var(--mono);font-size:.62rem;letter-spacing:.1em;color:var(--cyan);}
.cam-wrap img{width:100%;border-radius:8px;margin-top:.5rem;
  border:1px solid var(--border);display:block;min-height:200px;background:#0a1520;}
.pulse-dot{display:inline-block;width:8px;height:8px;background:var(--cyan);
  border-radius:50%;margin-right:6px;vertical-align:middle;
  animation:pulseDot 1.5s infinite;}
@keyframes pulseDot{
  0%{box-shadow:0 0 0 0 rgba(0,212,255,.6)}
  70%{box-shadow:0 0 0 8px rgba(0,212,255,0)}
  100%{box-shadow:0 0 0 0 rgba(0,212,255,0)}}
/* â”€â”€ Buttons â”€â”€ */
.btn{background:transparent;border:1px solid var(--cyan);color:var(--cyan);
  font-family:var(--mono);font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;
  padding:.55rem 1.4rem;border-radius:6px;cursor:pointer;transition:all .2s;}
.btn:hover{background:var(--cyan);color:var(--bg);box-shadow:0 0 18px rgba(0,212,255,.35);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-danger{border-color:var(--danger);color:var(--danger);}
.btn-danger:hover{background:var(--danger);color:#fff;}
/* â”€â”€ Slider â”€â”€ */
input[type=range]{width:100%;accent-color:var(--cyan);margin:.5rem 0;}
input[type=range]+.range-val{font-family:var(--mono);font-size:.65rem;color:var(--cyan);}
/* â”€â”€ HR Chart â”€â”€ */
#hr-chart-canvas{width:100%;height:140px;border-radius:8px;
  background:var(--surface);border:1px solid var(--border);display:block;}
/* â”€â”€ Heatmap â”€â”€ */
#heatmap-wrap{overflow-x:auto;}
table.heatmap{border-collapse:collapse;width:100%;font-family:var(--mono);font-size:.62rem;}
table.heatmap th{padding:6px 8px;color:var(--muted);text-align:center;font-weight:400;}
table.heatmap td{padding:6px 8px;text-align:center;border-radius:4px;color:var(--text);}
/* â”€â”€ Separator â”€â”€ */
.sep{border:none;border-top:1px solid var(--border);margin:1.8rem 0;}
/* â”€â”€ Module pages â”€â”€ */
.module-page{display:none;}
.module-page.active{display:block;}
/* â”€â”€ Loading spinner â”€â”€ */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);
  border-top-color:var(--cyan);border-radius:50%;animation:spin .8s linear infinite;
  margin-right:6px;vertical-align:middle;}
@keyframes spin{to{transform:rotate(360deg)}}
/* â”€â”€ Small stat â”€â”€ */
.small-stat{margin-bottom:12px;}
.small-stat .sl{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;color:var(--muted);}
.small-stat .sv{font-family:var(--mono);font-size:1.35rem;font-weight:700;color:var(--cyan);}
.small-stat .sv.ok{color:var(--green);}
.small-stat .sv.warn{color:var(--warn);}
.small-stat .sv.danger{color:var(--danger);}

/* â”€â”€ SSE Stream indicator â”€â”€ */
.stream-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:#4a6a8a;margin-right:5px;vertical-align:middle;}
.stream-dot.live{background:var(--green);animation:pulseDot 1s infinite;}
/* â”€â”€ Alert panel â”€â”€ */
.alert-panel{position:fixed;top:0;right:0;width:380px;height:100vh;
  background:#0a1520;border-left:1px solid var(--border);z-index:200;
  transform:translateX(100%);transition:transform .3s ease;display:flex;flex-direction:column;}
.alert-panel.open{transform:translateX(0);}
.alert-panel-head{padding:1rem 1.2rem;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;}
.alert-panel-title{font-family:var(--mono);font-size:.68rem;letter-spacing:.14em;color:var(--cyan);}
.alert-list{flex:1;overflow-y:auto;padding:.8rem;}
.alert-item{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:.75rem 1rem;margin-bottom:.6rem;position:relative;overflow:hidden;}
.alert-item::before{content:'';position:absolute;left:0;top:0;width:3px;height:100%;}
.alert-item.critical::before{background:var(--danger);}
.alert-item.warning::before{background:var(--warn);}
.alert-item.info::before{background:var(--cyan);}
.alert-time{font-family:var(--mono);font-size:.55rem;color:var(--muted);}
.alert-title-txt{font-family:var(--mono);font-size:.7rem;color:var(--text);margin:.2rem 0;}
.alert-msg{font-family:var(--mono);font-size:.6rem;color:var(--muted);line-height:1.5;}
.alert-badge-count{position:absolute;top:-4px;right:-4px;background:var(--danger);
  color:#fff;border-radius:50%;width:18px;height:18px;font-size:.6rem;
  display:none;align-items:center;justify-content:center;font-family:var(--mono);}
.alert-badge-count.show{display:flex;}
/* â”€â”€ Emergency panel â”€â”€ */
.emergency-panel{position:fixed;inset:0;z-index:300;background:rgba(5,10,16,.9);
  backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;}
.emergency-panel.open{display:flex;}
.emergency-box{background:var(--card);border:1px solid var(--danger);border-radius:16px;
  padding:2rem;width:480px;max-width:95vw;}
.emergency-title{font-family:var(--mono);font-size:.9rem;color:var(--danger);
  letter-spacing:.1em;margin-bottom:1.2rem;}
.contact-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:.8rem 1rem;margin-bottom:.6rem;display:flex;justify-content:space-between;align-items:center;}
.contact-name{font-family:var(--mono);font-size:.7rem;color:var(--text);}
.contact-role{font-family:var(--mono);font-size:.58rem;color:var(--muted);}
.call-btn{background:rgba(255,69,96,.15);border:1px solid var(--danger);color:var(--danger);
  font-family:var(--mono);font-size:.62rem;padding:.4rem .9rem;border-radius:6px;
  cursor:pointer;text-decoration:none;transition:all .2s;}
.call-btn:hover{background:var(--danger);color:#fff;}
/* â”€â”€ Chatbot â”€â”€ */
.chat-panel{position:fixed;bottom:1.5rem;right:1.5rem;width:360px;z-index:250;
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  display:none;flex-direction:column;box-shadow:0 8px 40px rgba(0,0,0,.5);
  max-height:520px;}
.chat-panel.open{display:flex;}
.chat-head{padding:.8rem 1.1rem;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;}
.chat-head-title{font-family:var(--mono);font-size:.65rem;letter-spacing:.1em;color:var(--cyan);}
.chat-messages{flex:1;overflow-y:auto;padding:.8rem;display:flex;flex-direction:column;gap:.6rem;}
.chat-msg{padding:.55rem .85rem;border-radius:10px;font-family:var(--mono);
  font-size:.65rem;line-height:1.6;max-width:90%;}
.chat-msg.user{background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.2);
  color:var(--cyan);align-self:flex-end;}
.chat-msg.bot{background:var(--surface);border:1px solid var(--border);
  color:var(--text);align-self:flex-start;}
.chat-msg.bot.typing{color:var(--muted);}
.chat-input-row{display:flex;gap:.5rem;padding:.8rem;border-top:1px solid var(--border);}
.chat-input{flex:1;background:var(--surface);border:1px solid var(--border);
  border-radius:6px;padding:.5rem .75rem;color:var(--text);font-family:var(--mono);
  font-size:.65rem;outline:none;}
.chat-input:focus{border-color:var(--cyan);}
.chat-send{background:var(--cyan);border:none;color:var(--bg);border-radius:6px;
  padding:.5rem .9rem;cursor:pointer;font-family:var(--mono);font-size:.7rem;}
/* â”€â”€ Floating action buttons â”€â”€ */
.fab-group{position:fixed;bottom:1.5rem;right:1.5rem;display:flex;flex-direction:column;
  gap:.6rem;z-index:100;}
.fab{width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:1.2rem;
  transition:all .2s;position:relative;}
.fab-chat{background:var(--cyan);color:var(--bg);}
.fab-chat:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(0,212,255,.5);}
.fab-alert{background:var(--card);border:1px solid var(--border);color:var(--text);}
.fab-alert:hover{border-color:var(--warn);color:var(--warn);}
.fab-emergency{background:rgba(255,69,96,.15);border:1px solid var(--danger);color:var(--danger);}
.fab-emergency:hover{background:var(--danger);color:#fff;transform:scale(1.1);}
/* â”€â”€ Notification toast â”€â”€ */
.toast{position:fixed;top:1.2rem;left:50%;transform:translateX(-50%) translateY(-80px);
  background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:.75rem 1.4rem;font-family:var(--mono);font-size:.68rem;color:var(--text);
  z-index:400;transition:transform .3s ease;white-space:nowrap;
  box-shadow:0 4px 24px rgba(0,0,0,.4);}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.critical{border-color:var(--danger);color:var(--danger);}
.toast.warning{border-color:var(--warn);color:var(--warn);}
.toast.info{border-color:var(--cyan);color:var(--cyan);}
/* â”€â”€ Live stream badge â”€â”€ */
.stream-status{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;
  color:var(--muted);display:flex;align-items:center;gap:4px;}

</style>
</head>
<body>
<div class="layout">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-logo">VitalSense AI</div>

    <div class="sidebar-label">â—ˆ Modules</div>
    <a class="nav-btn {% if module=='face'  %}active{% endif %}" href="/dashboard?module=face">ğŸ‘ &nbsp; Face Scanner</a>
    <a class="nav-btn {% if module=='voice' %}active{% endif %}" href="/dashboard?module=voice">ğŸ™ &nbsp; Voice Risk</a>
    <a class="nav-btn {% if module=='heart' %}active{% endif %}" href="/dashboard?module=heart">â¤ &nbsp; Heart Monitor</a>

    <div class="status-box">
      <b>SYSTEM STATUS</b>
      Camera Feed &nbsp;Â·&nbsp; <span class="s-ok">READY</span><br>
      Audio Input &nbsp;Â·&nbsp; <span class="s-ok">READY</span><br>
      ML Model &nbsp;&nbsp;&nbsp;Â·&nbsp; <span class="s-ok">LOADED</span><br>
      Dataset &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Â·&nbsp; <span class="s-ok">LOADED</span>
    </div>

    <div class="sidebar-label" style="margin-top:1rem;">â—ˆ Tools</div>
    <button class="nav-btn" onclick="openAlerts()">ğŸ”” &nbsp; Alerts <span id="alert-count-badge" class="alert-badge-count"></span></button>
    <button class="nav-btn" onclick="openEmergency()">ğŸš¨ &nbsp; Emergency</button>
    <button class="nav-btn" onclick="toggleChat()">ğŸ¤– &nbsp; AI Chatbot</button>

    <div class="stream-status" style="margin-top:1rem;padding:.5rem .9rem;">
      <span class="stream-dot" id="stream-dot"></span>
      <span id="stream-label">SSE Disconnected</span>
    </div>

    <a class="back-btn" href="/">â† Back to Home</a>
  </aside>

  <!-- â”€â”€ Main â”€â”€ -->
  <main class="main">

    <!-- Header -->
    <div class="page-header">
      <div>
        <div class="page-title">VitalSense AI</div>
        <div class="page-sub">Preventive Health Monitoring Â· v2.0</div>
      </div>
      <span class="badge">â— SYSTEM ONLINE</span>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODULE: FACE SCANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-face" class="module-page {% if module=='face' %}active{% endif %}">
      <div class="section-head">â—ˆ Face Health Scanner â€” Micro-Expression Analysis</div>

      <div class="grid-2">
        <!-- Camera -->
        <div class="card">
          <div class="cam-wrap">
            <span class="pulse-dot"></span>LIVE FEED
            <span id="face-sim-badge" style="display:none;margin-left:8px;font-size:.55rem;color:#ffb800;letter-spacing:.1em;">â—ˆ SIMULATION MODE</span>
            <canvas id="face-canvas" width="640" height="360"
              style="width:100%;border-radius:8px;margin-top:.5rem;border:1px solid var(--border);display:block;background:#080d14;"></canvas>
          </div>
        </div>

        <!-- Metrics -->
        <div>
          <div class="card" id="stress-card">
            <div class="metric-label">Stress Level</div>
            <div class="metric-value" id="stress-val">â€”</div>
            <div class="progress"><div class="progress-fill" id="stress-bar" style="width:0%"></div></div>
            <div id="stress-pill"></div>
          </div>
          <div class="card" id="fatigue-card">
            <div class="metric-label">Fatigue Score</div>
            <div class="metric-value" id="fatigue-val">â€”</div>
            <div class="progress"><div class="progress-fill" id="fatigue-bar" style="width:0%"></div></div>
            <div id="fatigue-pill"></div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:1rem;margin-top:.5rem;">
        <button class="btn" id="face-start-btn">â–¶ Start Camera</button>
        <button class="btn btn-danger" id="face-stop-btn" disabled>â¹ Stop</button>
      </div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODULE: VOICE RISK
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-voice" class="module-page {% if module=='voice' %}active{% endif %}">
      <div class="section-head">â—ˆ Voice Disease Risk Predictor â€” Acoustic Analysis</div>

      <div class="card" style="margin-bottom:1.5rem;">
        <span style="font-family:var(--mono);font-size:.65rem;color:var(--muted);">
          Speak naturally for the selected duration. The system analyses vocal biomarkers
          including pitch variance, jitter, shimmer, and harmonic-to-noise ratio to estimate
          disease risk probability.
        </span>
      </div>

      <div class="grid-2">
        <!-- Controls -->
        <div class="card">
          <div class="metric-label">Recording Settings</div>
          <br>
          <div class="metric-label">Duration</div>
          <input type="range" id="duration-slider" min="3" max="10" value="5"
                 oninput="document.getElementById('dur-val').textContent=this.value+'s'"/>
          <div class="range-val" id="dur-val">5s</div>
          <br><br>
          <button class="btn" id="record-btn">âº Record Voice</button>
          <div id="recording-status" style="margin-top:1rem;"></div>
        </div>

        <!-- Results -->
        <div id="voice-results" style="display:none;">
          <div class="grid-equal">
            <div class="card" id="anxiety-card">
              <div class="metric-label">Anxiety Risk</div>
              <div class="metric-value" id="anxiety-val">â€”</div>
              <div class="progress"><div class="progress-fill" id="anxiety-bar" style="width:0%"></div></div>
              <div id="anxiety-pill"></div>
            </div>
            <div class="card" id="asthma-card">
              <div class="metric-label">Asthma Risk</div>
              <div class="metric-value" id="asthma-val">â€”</div>
              <div class="progress"><div class="progress-fill" id="asthma-bar" style="width:0%"></div></div>
              <div id="asthma-pill"></div>
            </div>
          </div>
          <span class="pill pill-ok" id="voice-complete-badge" style="display:none;">âœ“ ANALYSIS COMPLETE â€” voice.wav saved</span>
        </div>
      </div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODULE: HEART MONITOR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-heart" class="module-page {% if module=='heart' %}active{% endif %}">
      <div class="section-head">â—ˆ Camera Heart Risk Monitor â€” rPPG Analysis</div>

      <div class="grid-2">
        <!-- Camera -->
        <div class="card">
          <div class="cam-wrap">
            <span class="pulse-dot"></span>LIVE FEED
            <span id="heart-sim-badge" style="display:none;margin-left:8px;font-size:.55rem;color:#ffb800;letter-spacing:.1em;">â—ˆ SIMULATION MODE</span>
            <canvas id="heart-canvas" width="640" height="360"
              style="width:100%;border-radius:8px;margin-top:.5rem;border:1px solid var(--border);display:block;background:#080d14;"></canvas>
          </div>
        </div>

        <!-- Heart vitals -->
        <div>
          <div class="card" id="hr-card">
            <div class="metric-label">Heart Rate</div>
            <div class="metric-value large" id="hr-val">â€”<span style="font-size:1rem;color:var(--muted);"> BPM</span></div>
            <div id="hr-status" style="margin-top:10px;"></div>
          </div>

          <div class="card">
            <div class="metric-label" style="margin-bottom:12px;">Secondary Signals</div>
            <div class="grid-equal">
              <div>
                <div class="small-stat">
                  <div class="sl">SpOâ‚‚</div>
                  <div class="sv" id="spo2-val">â€”</div>
                </div>
                <div class="small-stat">
                  <div class="sl">Activity</div>
                  <div class="sv" id="activity-val">â€”</div>
                </div>
              </div>
              <div>
                <div class="small-stat">
                  <div class="sl">Temp</div>
                  <div class="sv" id="temp-val">â€”</div>
                </div>
                <div class="small-stat">
                  <div class="sl">HRV</div>
                  <div class="sv ok" id="hrv-val">â€”</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:1rem;margin:.5rem 0 1.2rem;">
        <button class="btn" id="heart-start-btn">â–¶ Start Monitor</button>
        <button class="btn btn-danger" id="heart-stop-btn" disabled>â¹ Stop</button>
      </div>

      <!-- HR Chart -->
      <div class="section-head">â—ˆ Heart Rate Trend</div>
      <div class="card">
        <canvas id="hr-chart-canvas"></canvas>
      </div>
    </div>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CORRELATION HEATMAP  (always visible)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <hr class="sep"/>
    <div class="section-head">â—ˆ Multi-Signal Correlation Analysis</div>
    <div class="card">
      <div id="heatmap-wrap"><p style="font-family:var(--mono);font-size:.65rem;color:var(--muted);">Loading correlation dataâ€¦</p></div>
    </div>

  </main>
</div><!-- /layout -->


<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITIES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function cls(val){return val==='danger'?'danger':val==='warn'?'warn':'ok';}
function pillHtml(c,label){return `<span class="pill pill-${c}">${label}</span>`;}
function fillBar(el,pct,c){
  el.style.width=pct+'%';
  el.className='progress-fill fill-'+c;
}
function cardCls(card,c){
  card.className='card';
  if(c==='danger')card.classList.add('card-danger');
  else if(c==='warn')card.classList.add('card-warn');
  else card.classList.add('card-ok');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FACE SCANNER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Canvas drawing utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawFeedCanvas(canvas, label, simulated){
  const ctx=canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#080d14';ctx.fillRect(0,0,W,H);
  // Grid
  ctx.strokeStyle='rgba(0,40,60,.6)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=52){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=52){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  // ECG
  const t=Date.now()/1000;
  ctx.beginPath();ctx.strokeStyle='rgba(0,200,240,.7)';ctx.lineWidth=2;
  ctx.shadowColor='rgba(0,200,240,.5)';ctx.shadowBlur=6;
  for(let i=0;i<W;i+=2){
    const phase=(i/W)*Math.PI*8+t*2;
    const p=((phase%(2*Math.PI))+(2*Math.PI))%(2*Math.PI);
    let v;
    if(p<0.15)v=p/0.15*50;
    else if(p<0.25)v=50*(1-(p-0.15)/0.1);
    else if(p<0.35)v=-13*(1-(p-0.25)/0.1);
    else v=Math.sin(phase)*5;
    const y=H*0.6-v;
    if(i===0)ctx.moveTo(i,y);else ctx.lineTo(i,y);
  }
  ctx.stroke();ctx.shadowBlur=0;
  // Face bracket
  const cx=W/2,cy=H/2-10,r=65;
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle='rgba(0,200,240,.5)';ctx.lineWidth=1;ctx.stroke();
  const ls=12;
  [[cx-r,cy-r,1,1],[cx+r,cy-r,-1,1],[cx-r,cy+r,1,-1],[cx+r,cy+r,-1,-1]].forEach(([px,py,dx,dy])=>{
    ctx.beginPath();ctx.strokeStyle='#00ff9d';ctx.lineWidth=2;
    ctx.moveTo(px,py);ctx.lineTo(px+dx*ls,py);ctx.stroke();
    ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(px,py+dy*ls);ctx.stroke();
  });
  // Scan line
  const scanY=cy-r+((Date.now()/16)%(r*2));
  if(scanY>cy-r&&scanY<cy+r){
    ctx.beginPath();ctx.strokeStyle='rgba(0,212,255,.25)';ctx.lineWidth=1;
    ctx.moveTo(cx-r,scanY);ctx.lineTo(cx+r,scanY);ctx.stroke();
  }
  // Labels
  ctx.font='12px IBM Plex Mono, monospace';
  ctx.fillStyle='rgba(0,200,240,.9)';
  ctx.fillText(label,16,22);
  if(simulated){
    ctx.font='10px IBM Plex Mono, monospace';
    ctx.fillStyle='rgba(55,85,110,.9)';
    ctx.fillText('SIMULATION â€” no camera on cloud server',16,H-12);
  }
}

let faceAnimId=null;
function startFaceCanvasAnim(){
  const canvas=document.getElementById('face-canvas');
  if(faceAnimId)return;
  (function loop(){faceAnimId=requestAnimationFrame(loop);drawFeedCanvas(canvas,'FACE SCANNER',true);})();
}
function stopFaceCanvasAnim(){cancelAnimationFrame(faceAnimId);faceAnimId=null;}

let heartAnimId=null;
function startHeartCanvasAnim(){
  const canvas=document.getElementById('heart-canvas');
  if(heartAnimId)return;
  (function loop(){heartAnimId=requestAnimationFrame(loop);drawFeedCanvas(canvas,'HEART MONITOR',true);})();
}
function stopHeartCanvasAnim(){cancelAnimationFrame(heartAnimId);heartAnimId=null;}

// Draw base64 image onto canvas
function drawImageOnCanvas(canvas, b64){
  const img=new Image();
  img.onload=()=>{
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0,canvas.width,canvas.height);
  };
  img.src='data:image/jpeg;base64,'+b64;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FACE SCANNER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let faceInterval=null;
const stressVal   = document.getElementById('stress-val');
const stressBar   = document.getElementById('stress-bar');
const stressPill  = document.getElementById('stress-pill');
const stressCard  = document.getElementById('stress-card');
const fatigueVal  = document.getElementById('fatigue-val');
const fatigueBar  = document.getElementById('fatigue-bar');
const fatiguePill = document.getElementById('fatigue-pill');
const fatigueCard = document.getElementById('fatigue-card');

async function fetchFaceFrame(){
  try{
    const r=await fetch('/api/face/frame');
    if(!r.ok)return;
    const d=await r.json();
    if(d.error)return;

    // Show sim badge if no real camera
    document.getElementById('face-sim-badge').style.display = d.simulated ? 'inline' : 'none';

    if(d.simulated){
      // Canvas animation already running â€” no need to draw static image
    } else {
      stopFaceCanvasAnim();
      drawImageOnCanvas(document.getElementById('face-canvas'), d.image);
    }

    stressVal.textContent = d.stress+' / 100';
    fillBar(stressBar, d.stress, cls(d.stress_cls));
    stressPill.innerHTML = pillHtml(d.stress_cls, d.stress>70?'âš  HIGH STRESS':d.stress>45?'â–³ MODERATE':'âœ“ NORMAL');
    cardCls(stressCard, d.stress_cls);

    fatigueVal.textContent = d.fatigue+' / 100';
    fillBar(fatigueBar, d.fatigue, cls(d.fatigue_cls));
    fatiguePill.innerHTML = pillHtml(d.fatigue_cls, d.fatigue>70?'âš  HIGH FATIGUE':d.fatigue>45?'â–³ MODERATE':'âœ“ NORMAL');
    cardCls(fatigueCard, d.fatigue_cls);
  }catch(e){console.error('face frame error',e);}
}

document.getElementById('face-start-btn').addEventListener('click',()=>{
  if(faceInterval)return;
  startFaceCanvasAnim();  // immediate visual feedback
  faceInterval=setInterval(fetchFaceFrame,1000);
  fetchFaceFrame();
  document.getElementById('face-start-btn').disabled=true;
  document.getElementById('face-stop-btn').disabled=false;
});
document.getElementById('face-stop-btn').addEventListener('click',()=>{
  clearInterval(faceInterval);faceInterval=null;
  stopFaceCanvasAnim();
  document.getElementById('face-start-btn').disabled=false;
  document.getElementById('face-stop-btn').disabled=true;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VOICE RECORDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('record-btn').addEventListener('click',async()=>{
  const btn=document.getElementById('record-btn');
  const dur=parseInt(document.getElementById('duration-slider').value);
  const status=document.getElementById('recording-status');

  btn.disabled=true;
  status.innerHTML=`
    <div class="card card-warn" style="padding:.8rem 1rem;">
      <span class="pulse-dot"></span>
      <span style="font-family:var(--mono);font-size:.7rem;color:var(--warn);">RECORDING IN PROGRESSâ€¦ ${dur}s</span>
    </div>`;

  try{
    const r=await fetch('/api/voice/record',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({duration:dur})
    });
    const d=await r.json();

    status.innerHTML='';
    document.getElementById('voice-results').style.display='block';
    document.getElementById('voice-complete-badge').style.display='inline-block';

    // Anxiety
    document.getElementById('anxiety-val').textContent=d.anxiety+'%';
    fillBar(document.getElementById('anxiety-bar'),d.anxiety,cls(d.anxiety_cls));
    document.getElementById('anxiety-pill').innerHTML=pillHtml(d.anxiety_cls,d.anxiety_lbl);
    cardCls(document.getElementById('anxiety-card'),d.anxiety_cls);

    // Asthma
    document.getElementById('asthma-val').textContent=d.asthma+'%';
    fillBar(document.getElementById('asthma-bar'),d.asthma,cls(d.asthma_cls));
    document.getElementById('asthma-pill').innerHTML=pillHtml(d.asthma_cls,d.asthma_lbl);
    cardCls(document.getElementById('asthma-card'),d.asthma_cls);

  }catch(e){
    status.innerHTML=`<span class="pill pill-danger">âš  Recording failed: ${e.message}</span>`;
  }
  btn.disabled=false;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HEART MONITOR + CHART
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let heartInterval=null;
const hrHistory=[];
const hrVal     =document.getElementById('hr-val');
const hrStatus  =document.getElementById('hr-status');
const hrCard    =document.getElementById('hr-card');
const spo2Val   =document.getElementById('spo2-val');
const tempVal   =document.getElementById('temp-val');
const activityVal=document.getElementById('activity-val');
const hrvVal    =document.getElementById('hrv-val');

// Chart setup
const chartCanvas=document.getElementById('hr-chart-canvas');
const chartCtx=chartCanvas.getContext('2d');
chartCanvas.width=chartCanvas.offsetWidth||800;
chartCanvas.height=140;
window.addEventListener('resize',()=>{
  chartCanvas.width=chartCanvas.offsetWidth;drawChart();
});

function drawChart(){
  const cw=chartCanvas.width,ch=chartCanvas.height;
  chartCtx.clearRect(0,0,cw,ch);
  if(hrHistory.length<2)return;

  const min=Math.min(...hrHistory)-5;
  const max=Math.max(...hrHistory)+5;
  const scaleY=v=>(ch-20)-(v-min)/(max-min)*(ch-40)+10;
  const scaleX=i=>i/(hrHistory.length-1)*cw;

  // Grid lines
  chartCtx.strokeStyle='rgba(30,51,84,.6)';chartCtx.lineWidth=1;
  for(let y=0;y<=4;y++){
    const py=10+(ch-40)*y/4;
    chartCtx.beginPath();chartCtx.moveTo(0,py);chartCtx.lineTo(cw,py);chartCtx.stroke();
  }

  // Gradient fill
  const grad=chartCtx.createLinearGradient(0,0,0,ch);
  grad.addColorStop(0,'rgba(0,212,255,.25)');
  grad.addColorStop(1,'rgba(0,212,255,0)');
  chartCtx.beginPath();
  chartCtx.moveTo(scaleX(0),ch);
  hrHistory.forEach((v,i)=>chartCtx.lineTo(scaleX(i),scaleY(v)));
  chartCtx.lineTo(scaleX(hrHistory.length-1),ch);
  chartCtx.closePath();
  chartCtx.fillStyle=grad;
  chartCtx.fill();

  // Line
  chartCtx.beginPath();
  hrHistory.forEach((v,i)=>{
    if(i===0)chartCtx.moveTo(scaleX(i),scaleY(v));
    else chartCtx.lineTo(scaleX(i),scaleY(v));
  });
  chartCtx.strokeStyle='#00d4ff';
  chartCtx.lineWidth=2;
  chartCtx.shadowColor='rgba(0,212,255,.5)';
  chartCtx.shadowBlur=6;
  chartCtx.stroke();
  chartCtx.shadowBlur=0;

  // Latest value dot
  const last=hrHistory.length-1;
  chartCtx.beginPath();
  chartCtx.arc(scaleX(last),scaleY(hrHistory[last]),4,0,Math.PI*2);
  chartCtx.fillStyle='#00d4ff';chartCtx.fill();

  // Y-axis labels
  chartCtx.fillStyle='#4a6a8a';
  chartCtx.font='10px IBM Plex Mono, monospace';
  chartCtx.textAlign='right';
  for(let y=0;y<=4;y++){
    const val=Math.round(min+(max-min)*(1-y/4));
    const py=10+(ch-40)*y/4;
    chartCtx.fillText(val,38,py+4);
  }
}

async function fetchHeartFrame(){
  try{
    const r=await fetch('/api/heart/frame');
    if(!r.ok)return;
    const d=await r.json();
    if(d.error)return;

    document.getElementById('heart-sim-badge').style.display = d.simulated ? 'inline' : 'none';
    if(d.simulated){
      // canvas animation running
    } else {
      stopHeartCanvasAnim();
      drawImageOnCanvas(document.getElementById('heart-canvas'), d.image);
    }

    // HR display
    const hc=d.at_risk?'danger':'ok';
    hrVal.innerHTML=d.heart_rate+' <span style="font-size:1rem;color:var(--muted);">BPM</span>';
    hrVal.className='metric-value large '+(d.at_risk?'danger':'');
    hrStatus.innerHTML=pillHtml(hc, d.at_risk?'âš  EARLY CARDIAC RISK DETECTED':'âœ“ NORMAL CONDITION');
    cardCls(hrCard, hc);

    // Secondaries
    spo2Val.textContent=d.spo2+'%';
    spo2Val.className='sv '+d.spo2_cls;
    tempVal.textContent=d.temperature+'Â°C';
    tempVal.className='sv '+d.temp_cls;
    activityVal.textContent=d.activity+'/10';
    hrvVal.textContent=d.hrv+' ms';

    // Chart
    if(d.hr_history){
      hrHistory.length=0;
      d.hr_history.forEach(v=>hrHistory.push(v));
      drawChart();
    }
  }catch(e){console.error('heart frame error',e);}
}

document.getElementById('heart-start-btn').addEventListener('click',()=>{
  if(heartInterval)return;
  startHeartCanvasAnim();
  fetch('/api/heart/reset');
  heartInterval=setInterval(fetchHeartFrame,1000);
  fetchHeartFrame();
  document.getElementById('heart-start-btn').disabled=true;
  document.getElementById('heart-stop-btn').disabled=false;
});
document.getElementById('heart-stop-btn').addEventListener('click',()=>{
  clearInterval(heartInterval);heartInterval=null;
  stopHeartCanvasAnim();
  document.getElementById('heart-start-btn').disabled=false;
  document.getElementById('heart-stop-btn').disabled=true;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CORRELATION HEATMAP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadHeatmap(){
  try{
    const r=await fetch('/api/correlation');
    const d=await r.json();
    const cols=d.columns;
    const mat=d.matrix;

    // Color scale: -1 â†’ cyan, 0 â†’ dark, +1 â†’ green
    function heatColor(v){
      if(v>0){
        const t=v;
        const r=Math.round(0*(1-t)+0*t);
        const g=Math.round(212*(1-t)+255*t);
        const b=Math.round(255*(1-t)+157*t);
        return `rgba(${r},${g},${b},${0.15+t*0.5})`;
      }else{
        const t=-v;
        return `rgba(255,69,96,${0.1+t*0.4})`;
      }
    }

    let html='<table class="heatmap"><thead><tr><th></th>';
    cols.forEach(c=>html+=`<th>${c}</th>`);
    html+='</tr></thead><tbody>';
    mat.forEach((row,i)=>{
      html+=`<tr><th style="text-align:left;padding-right:12px;color:var(--muted);">${cols[i]}</th>`;
      row.forEach(v=>{
        const bg=heatColor(v);
        const txt=v===1?'1.00':v.toFixed(2);
        html+=`<td style="background:${bg};">${txt}</td>`;
      });
      html+='</tr>';
    });
    html+='</tbody></table>';
    document.getElementById('heatmap-wrap').innerHTML=html;
  }catch(e){
    document.getElementById('heatmap-wrap').innerHTML=
      '<p style="font-family:var(--mono);font-size:.65rem;color:var(--muted);">Could not load correlation data.</p>';
  }
}
loadHeatmap();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTO-START active module camera
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const activeModule='{{ module }}';
if(activeModule==='face'){  startFaceCanvasAnim(); document.getElementById('face-start-btn').click(); }
if(activeModule==='heart'){ startHeartCanvasAnim(); document.getElementById('heart-start-btn').click(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘  SSE STREAMING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sseSource = null;
let liveVitals = {};
let unreadAlerts = 0;

function connectSSE(){
  if(sseSource) sseSource.close();
  sseSource = new EventSource('/api/stream');

  sseSource.addEventListener('connected', ()=>{
    document.getElementById('stream-dot').classList.add('live');
    document.getElementById('stream-label').textContent = 'SSE Live';
  });

  sseSource.addEventListener('vitals', e=>{
    const d = JSON.parse(e.data);
    liveVitals = d;
    // Update heart module if active
    if(document.getElementById('page-heart').classList.contains('active')){
      hrVal.innerHTML = d.heart_rate + ' <span style="font-size:1rem;color:var(--muted);">BPM</span>';
      hrVal.className = 'metric-value large ' + (d.at_risk ? 'danger' : '');
      hrStatus.innerHTML = pillHtml(d.at_risk?'danger':'ok',
        d.at_risk ? 'âš  EARLY CARDIAC RISK DETECTED' : 'âœ“ NORMAL CONDITION');
      cardCls(hrCard, d.at_risk?'danger':'ok');
      spo2Val.textContent = d.spo2+'%'; spo2Val.className='sv '+d.spo2_cls;
      tempVal.textContent = d.temperature+'Â°C'; tempVal.className='sv '+d.temp_cls;
      activityVal.textContent = d.activity+'/10';
      hrvVal.textContent = d.hrv+' ms';
      if(d.hr_history){ hrHistory.length=0; d.hr_history.forEach(v=>hrHistory.push(v)); drawChart(); }
    }
  });

  sseSource.addEventListener('alert', e=>{
    const d = JSON.parse(e.data);
    addAlertToPanel(d);
    showToast(d.title, d.level==='critical'?'critical':d.level==='warning'?'warning':'info');
    // Browser notification
    if(Notification.permission === 'granted'){
      new Notification('VitalSense AI â€” '+d.title, {body: d.message, icon: '/favicon.ico'});
    }
  });

  sseSource.addEventListener('notification', e=>{
    const d = JSON.parse(e.data);
    showToast('ğŸ”” '+d.title+': '+d.body, d.level||'info');
    if(Notification.permission === 'granted'){
      new Notification(d.title, {body: d.body});
    }
  });

  sseSource.addEventListener('alerts_cleared', ()=>{
    document.getElementById('alert-list').innerHTML =
      '<p style="font-family:var(--mono);font-size:.65rem;color:var(--muted);text-align:center;padding:2rem;">Alerts cleared.</p>';
    unreadAlerts = 0; updateBadge();
  });

  sseSource.onerror = ()=>{
    document.getElementById('stream-dot').classList.remove('live');
    document.getElementById('stream-label').textContent = 'Reconnectingâ€¦';
    setTimeout(connectSSE, 3000);
  };
}
connectSSE();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘¡ EMERGENCY ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEmergency(){ document.getElementById('emergency-panel').classList.add('open'); }
function closeEmergency(){ document.getElementById('emergency-panel').classList.remove('open'); }

async function triggerEmergency(){
  const reason = prompt('Describe the emergency (optional):') || 'Manual emergency trigger';
  const r = await fetch('/api/emergency/trigger',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({reason, vitals: liveVitals})
  });
  const d = await r.json();
  closeEmergency();
  showToast('ğŸš¨ Emergency alert sent to '+d.contacts.length+' contacts','critical');
  addAlertToPanel(d.alert);
}

// Alert Panel
function openAlerts(){
  document.getElementById('alert-panel').classList.add('open');
  unreadAlerts=0; updateBadge();
}
function closeAlerts(){ document.getElementById('alert-panel').classList.remove('open'); }

function addAlertToPanel(a){
  const list = document.getElementById('alert-list');
  const empty = list.querySelector('p');
  if(empty) empty.remove();
  const div = document.createElement('div');
  div.className = 'alert-item ' + a.level;
  div.innerHTML = `
    <div class="alert-time">${a.timestamp}</div>
    <div class="alert-title-txt">${a.title}</div>
    <div class="alert-msg">${a.message}</div>`;
  list.prepend(div);
  unreadAlerts++;
  updateBadge();
  // Keep max 20 shown
  const items = list.querySelectorAll('.alert-item');
  if(items.length > 20) items[items.length-1].remove();
}

function updateBadge(){
  ['alert-count-badge','fab-badge'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(unreadAlerts>0){
      el.textContent = unreadAlerts > 9 ? '9+' : unreadAlerts;
      el.classList.add('show');
    } else {
      el.classList.remove('show');
    }
  });
}

async function clearAlerts(){
  await fetch('/api/alerts/clear',{method:'POST'});
}

// Load existing alerts on page load
async function loadAlerts(){
  const r = await fetch('/api/alerts');
  const d = await r.json();
  d.alerts.forEach(a => addAlertToPanel(a));
}
loadAlerts();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘¢ NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, level='info'){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + level + ' show';
  setTimeout(()=>t.classList.remove('show'), 4000);
}

// Request notification permission on load
function requestNotificationPermission(){
  if('Notification' in window && Notification.permission === 'default'){
    Notification.requestPermission();
  }
}
requestNotificationPermission();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘£ AI CHATBOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatHistory = [];
let chatOpen = false;

function toggleChat(){
  chatOpen = !chatOpen;
  document.getElementById('chat-panel').classList.toggle('open', chatOpen);
  document.getElementById('fab-group').style.display = chatOpen ? 'none' : 'flex';
  if(chatOpen) document.getElementById('chat-input').focus();
}

async function sendChat(){
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if(!msg) return;
  input.value = '';

  // Add user message
  appendChatMsg(msg, 'user');
  chatHistory.push({role:'user', content: msg});

  // Typing indicator
  const typingId = 'typing-'+Date.now();
  const msgs = document.getElementById('chat-messages');
  const typing = document.createElement('div');
  typing.className = 'chat-msg bot typing';
  typing.id = typingId;
  typing.textContent = 'â— â— â—';
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  try{
    const r = await fetch('/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        message: msg,
        vitals: liveVitals,
        history: chatHistory.slice(-6)
      })
    });
    const d = await r.json();
    document.getElementById(typingId)?.remove();
    const reply = d.reply || 'Sorry, I could not process that.';
    appendChatMsg(reply, 'bot');
    chatHistory.push({role:'assistant', content: reply});
    if(chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
  }catch(e){
    document.getElementById(typingId)?.remove();
    appendChatMsg('Connection error. Please try again.', 'bot');
  }
}

function appendChatMsg(text, role){
  const msgs = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  // Simple markdown bold
  div.innerHTML = text.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>');
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

</script>

<!-- â•â• NOTIFICATION TOAST â•â• -->
<div class="toast" id="toast"></div>

<!-- â•â• ALERT PANEL â•â• -->
<div class="alert-panel" id="alert-panel">
  <div class="alert-panel-head">
    <span class="alert-panel-title">â—ˆ ALERT LOG</span>
    <div style="display:flex;gap:.6rem;">
      <button class="btn" style="padding:.3rem .8rem;font-size:.58rem;" onclick="clearAlerts()">Clear All</button>
      <button class="btn btn-danger" style="padding:.3rem .8rem;font-size:.58rem;" onclick="closeAlerts()">âœ•</button>
    </div>
  </div>
  <div class="alert-list" id="alert-list">
    <p style="font-family:var(--mono);font-size:.65rem;color:var(--muted);text-align:center;padding:2rem;">
      No alerts yet. Monitoring active.
    </p>
  </div>
</div>

<!-- â•â• EMERGENCY PANEL â•â• -->
<div class="emergency-panel" id="emergency-panel">
  <div class="emergency-box">
    <div class="emergency-title">ğŸš¨ EMERGENCY RESPONSE</div>
    <p style="font-family:var(--mono);font-size:.62rem;color:var(--muted);margin-bottom:1.2rem;">
      Direct emergency contacts. Click CALL to initiate.
    </p>
    <div id="contact-list">
      {% for c in emergency_contacts %}
      <div class="contact-card">
        <div>
          <div class="contact-name">{{ c.name }}</div>
          <div class="contact-role">{{ c.role }}</div>
        </div>
        <a class="call-btn" href="tel:{{ c.phone }}">ğŸ“ CALL</a>
      </div>
      {% endfor %}
    </div>
    <hr class="sep" style="margin:1rem 0;">
    <button class="btn btn-danger" style="width:100%;" onclick="triggerEmergency()">
      ğŸš¨ TRIGGER FULL EMERGENCY ALERT
    </button>
    <button class="btn" style="width:100%;margin-top:.6rem;" onclick="closeEmergency()">Cancel</button>
  </div>
</div>

<!-- â•â• CHATBOT PANEL â•â• -->
<div class="chat-panel" id="chat-panel">
  <div class="chat-head">
    <span class="chat-head-title"><span class="pulse-dot"></span>AI HEALTH ASSISTANT</span>
    <button onclick="toggleChat()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;">âœ•</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-msg bot">Hello! I'm your VitalSense AI assistant. Ask me about your vitals, health risks, or emergency procedures.</div>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" type="text" placeholder="Ask about your health data..."
           onkeydown="if(event.key==='Enter')sendChat()"/>
    <button class="chat-send" onclick="sendChat()">â–¶</button>
  </div>
</div>

<!-- â•â• FAB BUTTONS (shown when chat is closed) â•â• -->
<div class="fab-group" id="fab-group">
  <button class="fab fab-emergency" onclick="openEmergency()" title="Emergency">ğŸš¨</button>
  <button class="fab fab-alert" onclick="openAlerts()" title="Alerts">
    ğŸ””<span class="alert-badge-count" id="fab-badge"></span>
  </button>
  <button class="fab fab-chat" onclick="toggleChat()" title="AI Chatbot">ğŸ¤–</button>
</div>

</body>
</html>

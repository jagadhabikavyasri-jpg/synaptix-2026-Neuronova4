<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>VitalSense AI â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#080d14;--surface:#0e1724;--card:#121e2e;--border:#1e3354;
  --cyan:#00d4ff;--green:#00ff9d;--danger:#ff4560;--warn:#ffb800;
  --text:#cde4f5;--muted:#4a6a8a;
  --mono:'Space Mono',monospace;--body:'DM Sans',sans-serif;
}
html,body{min-height:100vh;background:var(--bg);color:var(--text);font-family:var(--body);}
.layout{display:flex;min-height:100vh;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:230px;flex-shrink:0;background:linear-gradient(180deg,#060c14,#0a1828);
  border-right:1px solid var(--border);padding:1.5rem 1rem;
  display:flex;flex-direction:column;gap:.4rem;}
.sidebar-logo{font-family:var(--mono);font-size:1rem;font-weight:700;
  background:linear-gradient(90deg,var(--cyan),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:1.2rem;padding-bottom:1rem;border-bottom:1px solid var(--border);}
.sidebar-label{font-family:var(--mono);font-size:.55rem;letter-spacing:.18em;
  color:var(--cyan);text-transform:uppercase;margin:.8rem 0 .3rem;}
.nav-btn{display:block;width:100%;text-align:left;background:transparent;
  border:1px solid transparent;border-radius:8px;padding:.55rem .9rem;cursor:pointer;
  font-family:var(--mono);font-size:.62rem;letter-spacing:.06em;color:var(--muted);
  transition:all .2s;text-decoration:none;}
.nav-btn:hover,.nav-btn.active{background:var(--card);border-color:var(--border);color:var(--cyan);}

/* stream status dot */
.stream-row{display:flex;align-items:center;gap:6px;padding:.4rem .9rem;
  font-family:var(--mono);font-size:.55rem;color:var(--muted);}
.sdot{width:7px;height:7px;border-radius:50%;background:#1e3354;flex-shrink:0;}
.sdot.live{background:var(--green);animation:sdPulse 1.2s infinite;}
@keyframes sdPulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,157,.5)}50%{box-shadow:0 0 0 5px rgba(0,255,157,0)}}

.status-box{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:.75rem;margin-top:auto;font-family:var(--mono);font-size:.53rem;
  color:var(--muted);line-height:2;}
.status-box b{color:var(--cyan);display:block;margin-bottom:.3rem;}
.s-ok{color:var(--green);}.s-warn{color:var(--warn);}
.back-btn{display:block;text-align:center;margin-top:.8rem;
  font-family:var(--mono);font-size:.58rem;color:var(--muted);text-decoration:none;
  padding:.45rem;border-radius:6px;border:1px solid var(--border);transition:all .2s;}
.back-btn:hover{border-color:var(--cyan);color:var(--cyan);}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;padding:1.6rem 1.8rem;overflow-y:auto;}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;
  margin-bottom:1.4rem;padding-bottom:1.1rem;border-bottom:1px solid var(--border);}
.page-title{font-family:var(--mono);font-size:1.7rem;font-weight:700;
  background:linear-gradient(90deg,var(--cyan),var(--green));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.page-sub{font-family:var(--mono);font-size:.62rem;letter-spacing:.14em;color:var(--muted);margin-top:2px;}
.online-badge{display:inline-block;background:rgba(0,255,157,.12);color:var(--green);
  border:1px solid rgba(0,255,157,.3);border-radius:20px;padding:4px 14px;
  font-family:var(--mono);font-size:.6rem;letter-spacing:.1em;}
.section-head{font-family:var(--mono);font-size:.6rem;letter-spacing:.2em;
  text-transform:uppercase;color:var(--cyan);border-left:3px solid var(--cyan);
  padding-left:10px;margin:1.4rem 0 .9rem;}
.sep{border:none;border-top:1px solid var(--border);margin:1.6rem 0;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;
  padding:1.1rem 1.3rem;margin-bottom:.9rem;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;
  background:linear-gradient(180deg,var(--cyan),transparent);}
.card-danger::before{background:linear-gradient(180deg,var(--danger),transparent);}
.card-warn::before  {background:linear-gradient(180deg,var(--warn),transparent);}
.card-ok::before    {background:linear-gradient(180deg,var(--green),transparent);}

/* â”€â”€ GRID â”€â”€ */
.grid-2{display:grid;grid-template-columns:3fr 2fr;gap:1rem;}
.grid-eq{display:grid;grid-template-columns:1fr 1fr;gap:.9rem;}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem;}

/* â”€â”€ METRIC â”€â”€ */
.metric-label{font-family:var(--mono);font-size:.56rem;letter-spacing:.12em;
  text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.metric-value{font-family:var(--mono);font-size:1.9rem;color:var(--cyan);font-weight:700;}
.metric-value.large{font-size:2.8rem;}
.metric-value.danger{color:var(--danger);}
.metric-value.ok{color:var(--green);}

/* â”€â”€ PROGRESS â”€â”€ */
.progress{background:#1e3354;border-radius:4px;height:5px;margin-top:7px;}
.progress-fill{height:5px;border-radius:4px;transition:width .5s;}
.fill-ok{background:var(--green);}.fill-warn{background:var(--warn);}.fill-danger{background:var(--danger);}

/* â”€â”€ PILLS â”€â”€ */
.pill{display:inline-block;border-radius:20px;padding:2px 12px;
  font-family:var(--mono);font-size:.62rem;letter-spacing:.08em;margin-top:8px;}
.pill-ok    {background:rgba(0,255,157,.12);color:var(--green);border:1px solid rgba(0,255,157,.3);}
.pill-warn  {background:rgba(255,184,0,.12) ;color:var(--warn) ;border:1px solid rgba(255,184,0,.3);}
.pill-danger{background:rgba(255,69,96,.12) ;color:var(--danger);border:1px solid rgba(255,69,96,.3);}

/* â”€â”€ CAMERA (MJPEG <img>) â”€â”€ */
.cam-wrap{font-family:var(--mono);font-size:.6rem;letter-spacing:.1em;color:var(--cyan);}
.cam-stream{width:100%;border-radius:8px;margin-top:.5rem;border:1px solid var(--border);
  display:block;min-height:220px;background:var(--surface);object-fit:cover;}
.cam-canvas{width:100%;border-radius:8px;margin-top:.5rem;border:1px solid var(--border);
  display:block;height:240px;background:var(--surface);}

/* â”€â”€ PULSE DOT â”€â”€ */
.pulse-dot{display:inline-block;width:7px;height:7px;background:var(--cyan);
  border-radius:50%;margin-right:5px;vertical-align:middle;animation:pDot 1.5s infinite;}
@keyframes pDot{0%{box-shadow:0 0 0 0 rgba(0,212,255,.6)}70%{box-shadow:0 0 0 7px rgba(0,212,255,0)}100%{box-shadow:0 0 0 0 rgba(0,212,255,0)}}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{background:transparent;border:1px solid var(--cyan);color:var(--cyan);
  font-family:var(--mono);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;
  padding:.5rem 1.2rem;border-radius:6px;cursor:pointer;transition:all .2s;}
.btn:hover{background:var(--cyan);color:var(--bg);box-shadow:0 0 16px rgba(0,212,255,.35);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-danger{border-color:var(--danger);color:var(--danger);}
.btn-danger:hover{background:var(--danger);color:#fff;box-shadow:0 0 16px rgba(255,69,96,.35);}
.btn-warn{border-color:var(--warn);color:var(--warn);}
.btn-warn:hover{background:var(--warn);color:var(--bg);}

/* â”€â”€ SLIDER â”€â”€ */
input[type=range]{width:100%;accent-color:var(--cyan);margin:.4rem 0;}

/* â”€â”€ CHART CANVAS â”€â”€ */
#hr-chart-canvas{width:100%;height:130px;display:block;border-radius:8px;
  background:var(--surface);border:1px solid var(--border);}

/* â”€â”€ HEATMAP â”€â”€ */
table.heatmap{border-collapse:collapse;width:100%;font-family:var(--mono);font-size:.6rem;}
table.heatmap th{padding:5px 7px;color:var(--muted);text-align:center;font-weight:400;}
table.heatmap td{padding:5px 7px;text-align:center;border-radius:3px;}

/* â”€â”€ SMALL STAT â”€â”€ */
.sstat{margin-bottom:10px;}
.sstat .sl{font-family:var(--mono);font-size:.55rem;letter-spacing:.1em;color:var(--muted);}
.sstat .sv{font-family:var(--mono);font-size:1.25rem;font-weight:700;color:var(--cyan);}
.sstat .sv.ok{color:var(--green);}.sstat .sv.warn{color:var(--warn);}.sstat .sv.danger{color:var(--danger);}

/* â”€â”€ MODULE PAGE SWITCHING â”€â”€ */
.module-page{display:none;}.module-page.active{display:block;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY â€” EMERGENCY PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;z-index:300;background:rgba(5,10,16,.92);
  backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;}
.overlay.open{display:flex;}
.overlay-box{background:var(--card);border-radius:16px;padding:2rem;
  width:460px;max-width:95vw;max-height:90vh;overflow-y:auto;}
.overlay-title{font-family:var(--mono);font-size:.85rem;letter-spacing:.1em;
  margin-bottom:1.1rem;}
.contact-row{background:var(--surface);border:1px solid var(--border);
  border-radius:8px;padding:.75rem 1rem;margin-bottom:.55rem;
  display:flex;justify-content:space-between;align-items:center;gap:.8rem;}
.contact-row.first-contact{border-color:var(--danger);}
.contact-info .cn{font-family:var(--mono);font-size:.68rem;color:var(--text);}
.contact-info .cr{font-family:var(--mono);font-size:.55rem;color:var(--muted);}
.call-link{background:rgba(255,69,96,.15);border:1px solid var(--danger);color:var(--danger);
  font-family:var(--mono);font-size:.6rem;padding:.38rem .85rem;border-radius:6px;
  cursor:pointer;text-decoration:none;transition:all .2s;white-space:nowrap;}
.call-link:hover{background:var(--danger);color:#fff;}
.call-link.primary{background:var(--danger);color:#fff;animation:callPulse 1.5s infinite;}
@keyframes callPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,69,96,.5)}50%{box-shadow:0 0 0 10px rgba(255,69,96,0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALERT SIDE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert-panel{position:fixed;top:0;right:0;width:360px;height:100vh;
  background:#0a1520;border-left:1px solid var(--border);z-index:200;
  transform:translateX(100%);transition:transform .3s;display:flex;flex-direction:column;}
.alert-panel.open{transform:translateX(0);}
.alert-head{padding:.9rem 1.1rem;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;}
.alert-head-title{font-family:var(--mono);font-size:.65rem;letter-spacing:.14em;color:var(--cyan);}
.alert-list{flex:1;overflow-y:auto;padding:.7rem;}
.alert-item{background:var(--card);border:1px solid var(--border);border-radius:8px;
  padding:.65rem .9rem;margin-bottom:.5rem;position:relative;overflow:hidden;}
.alert-item::before{content:'';position:absolute;left:0;top:0;width:3px;height:100%;}
.alert-item.critical::before{background:var(--danger);}
.alert-item.warning::before{background:var(--warn);}
.alert-item.info::before{background:var(--cyan);}
.a-time{font-family:var(--mono);font-size:.52rem;color:var(--muted);}
.a-title{font-family:var(--mono);font-size:.67rem;color:var(--text);margin:.18rem 0;}
.a-msg{font-family:var(--mono);font-size:.57rem;color:var(--muted);line-height:1.5;}

/* unread badge */
.ubadge{display:none;position:absolute;top:-5px;right:-5px;width:18px;height:18px;
  background:var(--danger);color:#fff;border-radius:50%;font-family:var(--mono);
  font-size:.58rem;align-items:center;justify-content:center;}
.ubadge.show{display:flex;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTO-CALL BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#autocall-banner{position:fixed;top:0;left:0;right:0;z-index:500;
  background:var(--danger);color:#fff;font-family:var(--mono);font-size:.78rem;
  padding:.65rem 1.2rem;display:none;align-items:center;justify-content:space-between;
  gap:1rem;box-shadow:0 2px 20px rgba(255,69,96,.6);}
#autocall-banner.show{display:flex;}
.autocall-info{display:flex;align-items:center;gap:.9rem;}
.autocall-pulse{display:inline-block;width:10px;height:10px;border-radius:50%;
  background:#fff;animation:acPulse .8s infinite;}
@keyframes acPulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHATBOT PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-panel{position:fixed;bottom:1.2rem;right:1.2rem;width:340px;z-index:250;
  background:var(--card);border:1px solid var(--border);border-radius:14px;
  display:none;flex-direction:column;max-height:500px;
  box-shadow:0 8px 40px rgba(0,0,0,.5);}
.chat-panel.open{display:flex;}
.chat-head{padding:.75rem 1rem;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;}
.chat-head-title{font-family:var(--mono);font-size:.62rem;letter-spacing:.1em;color:var(--cyan);}
.chat-vitals-bar{padding:.4rem 1rem;background:rgba(0,212,255,.06);
  border-bottom:1px solid var(--border);font-family:var(--mono);
  font-size:.52rem;color:var(--muted);letter-spacing:.05em;}
.chat-messages{flex:1;overflow-y:auto;padding:.75rem;display:flex;flex-direction:column;gap:.5rem;}
.chat-msg{padding:.5rem .8rem;border-radius:10px;font-family:var(--mono);
  font-size:.62rem;line-height:1.6;max-width:92%;}
.chat-msg.user{background:rgba(0,212,255,.12);border:1px solid rgba(0,212,255,.2);
  color:var(--cyan);align-self:flex-end;}
.chat-msg.bot{background:var(--surface);border:1px solid var(--border);
  color:var(--text);align-self:flex-start;}
.chat-msg.typing{color:var(--muted);}
.chat-input-row{display:flex;gap:.45rem;padding:.7rem;border-top:1px solid var(--border);}
.chat-input{flex:1;background:var(--surface);border:1px solid var(--border);
  border-radius:6px;padding:.45rem .7rem;color:var(--text);font-family:var(--mono);
  font-size:.62rem;outline:none;}
.chat-input:focus{border-color:var(--cyan);}
.chat-send{background:var(--cyan);border:none;color:var(--bg);border-radius:6px;
  padding:.45rem .85rem;cursor:pointer;font-family:var(--mono);font-size:.7rem;font-weight:700;}
.chat-send:hover{box-shadow:0 0 12px rgba(0,212,255,.4);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOATING ACTION BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab-group{position:fixed;bottom:1.2rem;right:1.2rem;
  display:flex;flex-direction:column;gap:.5rem;z-index:100;}
.fab{width:46px;height:46px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;transition:all .2s;position:relative;}
.fab-chat{background:var(--cyan);color:var(--bg);}
.fab-chat:hover{transform:scale(1.1);box-shadow:0 0 18px rgba(0,212,255,.5);}
.fab-alert{background:var(--card);border:1px solid var(--border);color:var(--text);}
.fab-alert:hover{border-color:var(--warn);color:var(--warn);}
.fab-emergency{background:rgba(255,69,96,.15);border:1px solid var(--danger);color:var(--danger);}
.fab-emergency:hover{background:var(--danger);color:#fff;transform:scale(1.08);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%) translateY(-90px);
  background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:.65rem 1.3rem;font-family:var(--mono);font-size:.65rem;
  z-index:600;transition:transform .3s;white-space:nowrap;
  box-shadow:0 4px 24px rgba(0,0,0,.5);}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.critical{border-color:var(--danger);color:var(--danger);}
.toast.warning {border-color:var(--warn);  color:var(--warn);}
.toast.info    {border-color:var(--cyan);  color:var(--cyan);}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• AUTO-CALL BANNER â•â•â•â•â•â•â•â•â•â•â• -->
<div id="autocall-banner">
  <div class="autocall-info">
    <span class="autocall-pulse"></span>
    <span id="autocall-text">ğŸ“ Auto-calling Dr. Sharma â€” Emergency detected</span>
  </div>
  <div style="display:flex;gap:.6rem;align-items:center;">
    <a id="autocall-link" href="#" class="call-link primary" style="font-size:.65rem;">ğŸ“ CALL NOW</a>
    <button onclick="dismissAutocall()" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);
      color:#fff;font-family:var(--mono);font-size:.6rem;padding:.3rem .7rem;border-radius:5px;cursor:pointer;">Dismiss</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast" id="toast"></div>

<div class="layout" style="margin-top:0;" id="main-layout">

  <!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="sidebar">
    <div class="sidebar-logo">VitalSense AI</div>

    <div class="sidebar-label">â—ˆ Modules</div>
    <a class="nav-btn {% if module=='face'  %}active{% endif %}" href="/dashboard?module=face">ğŸ‘ &nbsp; Face Scanner</a>
    <a class="nav-btn {% if module=='voice' %}active{% endif %}" href="/dashboard?module=voice">ğŸ™ &nbsp; Voice Risk</a>
    <a class="nav-btn {% if module=='heart' %}active{% endif %}" href="/dashboard?module=heart">â¤ &nbsp; Heart Monitor</a>

    <div class="sidebar-label">â—ˆ Tools</div>
    <button class="nav-btn" onclick="openAlerts()" style="position:relative;">
      ğŸ”” &nbsp; Alert Log
      <span class="ubadge" id="sidebar-badge" style="top:4px;right:8px;"></span>
    </button>
    <button class="nav-btn" onclick="openEmergency()">ğŸš¨ &nbsp; Emergency</button>
    <button class="nav-btn" onclick="toggleChat()">ğŸ¤– &nbsp; AI Chatbot</button>
    <button class="nav-btn" onclick="testNotif()" style="font-size:.58rem;">ğŸ”” Test Notification</button>

    <div class="stream-row">
      <span class="sdot" id="sse-dot"></span>
      <span id="sse-label">Connectingâ€¦</span>
    </div>

    <div class="status-box">
      <b>SYSTEM STATUS</b>
      Camera &nbsp;Â·&nbsp; <span class="{{ 'has_camera' | ternary('s-ok','s-warn') if has_camera else 's-warn' }}">
        {% if has_camera %}LIVE{% else %}SIM{% endif %}
      </span><br>
      Audio &nbsp;Â·&nbsp; <span class="{{ 's-ok' if has_audio else 's-warn' }}">
        {% if has_audio %}READY{% else %}SIM{% endif %}
      </span><br>
      ML Model &nbsp;Â·&nbsp; <span class="s-ok">LOADED</span><br>
      SSE Stream &nbsp;Â·&nbsp; <span class="s-ok" id="sse-status-txt">ACTIVE</span>
    </div>

    <a class="back-btn" href="/">â† Back to Home</a>
  </aside>

  <!-- â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• -->
  <main class="main">
    <div class="page-header">
      <div>
        <div class="page-title">VitalSense AI</div>
        <div class="page-sub">Preventive Health Monitoring Â· v3.0</div>
      </div>
      <span class="online-badge" id="sys-badge">â— SYSTEM ONLINE</span>
    </div>

    <!-- â•â•â•â•â•â•â•â• FACE SCANNER â•â•â•â•â•â•â•â• -->
    <div id="page-face" class="module-page {% if module=='face' %}active{% endif %}">
      <div class="section-head">â—ˆ Face Health Scanner â€” Micro-Expression Analysis</div>
      <div class="grid-2">
        <div class="card">
          <div class="cam-wrap">
            <span class="pulse-dot"></span>LIVE STREAM
            <span id="face-sim-badge" style="display:none;margin-left:8px;font-size:.52rem;color:var(--warn);">â—ˆ SIMULATION</span>
            <!-- MJPEG stream â€” browser pulls directly from /stream/face -->
            <img id="face-stream" class="cam-stream"
                 src="" alt=""
                 onerror="this.style.display='none';document.getElementById('face-canvas').style.display='block'"/>
            <canvas id="face-canvas" class="cam-canvas" style="display:none;"></canvas>
          </div>
        </div>
        <div>
          <div class="card" id="stress-card">
            <div class="metric-label">Stress Level</div>
            <div class="metric-value" id="stress-val">â€”</div>
            <div class="progress"><div class="progress-fill" id="stress-bar" style="width:0%"></div></div>
            <div id="stress-pill"></div>
          </div>
          <div class="card" id="fatigue-card">
            <div class="metric-label">Fatigue Score</div>
            <div class="metric-value" id="fatigue-val">â€”</div>
            <div class="progress"><div class="progress-fill" id="fatigue-bar" style="width:0%"></div></div>
            <div id="fatigue-pill"></div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:.8rem;margin-top:.4rem;">
        <button class="btn" id="face-start-btn">â–¶ Start Scanner</button>
        <button class="btn btn-danger" id="face-stop-btn" disabled>â¹ Stop</button>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â• VOICE RISK â•â•â•â•â•â•â•â• -->
    <div id="page-voice" class="module-page {% if module=='voice' %}active{% endif %}">
      <div class="section-head">â—ˆ Voice Disease Risk Predictor â€” Acoustic Analysis</div>
      <div class="card" style="margin-bottom:1.2rem;">
        <span style="font-family:var(--mono);font-size:.62rem;color:var(--muted);">
          Speak naturally for the selected duration. The system analyses pitch variance,
          jitter, shimmer, and harmonic-to-noise ratio to estimate disease risk probability.
        </span>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="metric-label">Recording Duration</div><br>
          <input type="range" id="dur-slider" min="3" max="10" value="5"
                 oninput="document.getElementById('dur-val').textContent=this.value+'s'"/>
          <div style="font-family:var(--mono);font-size:.62rem;color:var(--cyan);" id="dur-val">5s</div>
          <br>
          <button class="btn" id="record-btn">âº Record Voice</button>
          <div id="rec-status" style="margin-top:.8rem;"></div>
        </div>
        <div id="voice-results" style="display:none;">
          <div class="grid-eq">
            <div class="card" id="anxiety-card">
              <div class="metric-label">Anxiety Risk</div>
              <div class="metric-value" id="anxiety-val">â€”</div>
              <div class="progress"><div class="progress-fill" id="anxiety-bar" style="width:0%"></div></div>
              <div id="anxiety-pill"></div>
            </div>
            <div class="card" id="asthma-card">
              <div class="metric-label">Asthma Risk</div>
              <div class="metric-value" id="asthma-val">â€”</div>
              <div class="progress"><div class="progress-fill" id="asthma-bar" style="width:0%"></div></div>
              <div id="asthma-pill"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â• HEART MONITOR â•â•â•â•â•â•â•â• -->
    <div id="page-heart" class="module-page {% if module=='heart' %}active{% endif %}">
      <div class="section-head">â—ˆ Camera Heart Risk Monitor â€” rPPG + SSE Stream</div>
      <div class="grid-2">
        <div class="card">
          <div class="cam-wrap">
            <span class="pulse-dot"></span>LIVE STREAM
            <span id="heart-sim-badge" style="display:none;margin-left:8px;font-size:.52rem;color:var(--warn);">â—ˆ SIMULATION</span>
            <img id="heart-stream" class="cam-stream" src="" alt=""
                 onerror="this.style.display='none';document.getElementById('heart-canvas').style.display='block'"/>
            <canvas id="heart-canvas" class="cam-canvas" style="display:none;"></canvas>
          </div>
        </div>
        <div>
          <div class="card" id="hr-card">
            <div class="metric-label">Heart Rate <span style="font-size:.5rem;color:var(--green);">â— LIVE</span></div>
            <div class="metric-value large" id="hr-val">â€”<span style="font-size:1rem;color:var(--muted);"> BPM</span></div>
            <div id="hr-status" style="margin-top:8px;"></div>
          </div>
          <div class="card">
            <div class="metric-label" style="margin-bottom:10px;">Secondary Signals <span style="font-size:.5rem;color:var(--green);">â— LIVE</span></div>
            <div class="grid-eq">
              <div>
                <div class="sstat"><div class="sl">SpOâ‚‚</div><div class="sv" id="spo2-val">â€”</div></div>
                <div class="sstat"><div class="sl">Activity</div><div class="sv" id="act-val">â€”</div></div>
              </div>
              <div>
                <div class="sstat"><div class="sl">Temp</div><div class="sv" id="temp-val">â€”</div></div>
                <div class="sstat"><div class="sl">HRV</div><div class="sv ok" id="hrv-val">â€”</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:.8rem;margin:.4rem 0 1rem;">
        <button class="btn" id="heart-start-btn">â–¶ Start Monitor</button>
        <button class="btn btn-danger" id="heart-stop-btn" disabled>â¹ Stop</button>
      </div>
      <div class="section-head">â—ˆ Heart Rate Trend <span style="font-size:.5rem;color:var(--green);">â— STREAMING</span></div>
      <div class="card">
        <canvas id="hr-chart-canvas"></canvas>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â• CORRELATION HEATMAP â•â•â•â•â•â•â•â• -->
    <hr class="sep"/>
    <div class="section-head">â—ˆ Multi-Signal Correlation Analysis</div>
    <div class="card">
      <div id="heatmap-wrap"><p style="font-family:var(--mono);font-size:.62rem;color:var(--muted);">Loadingâ€¦</p></div>
    </div>

  </main>
</div><!-- /layout -->

<!-- â•â•â•â•â•â•â•â•â•â•â• EMERGENCY OVERLAY â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="emergency-overlay">
  <div class="overlay-box">
    <div class="overlay-title" style="color:var(--danger);">ğŸš¨ EMERGENCY RESPONSE</div>
    <p style="font-family:var(--mono);font-size:.6rem;color:var(--muted);margin-bottom:1rem;">
      First contact will be <strong style="color:var(--danger);">auto-called</strong> on emergency detection.
      Tap CALL to call manually.
    </p>
    <div id="contact-list">
      {% for c in emergency_contacts %}
      <div class="contact-row {% if loop.first %}first-contact{% endif %}">
        <div class="contact-info">
          <div class="cn">{% if loop.first %}â­ {% endif %}{{ c.name }}</div>
          <div class="cr">{{ c.role }} Â· {{ c.phone }}</div>
        </div>
        <a class="call-link {% if loop.first %}primary{% endif %}" href="tel:{{ c.phone }}">
          ğŸ“ CALL
        </a>
      </div>
      {% endfor %}
    </div>
    <hr class="sep" style="margin:.9rem 0;">
    <button class="btn btn-danger" style="width:100%;margin-bottom:.5rem;" onclick="manualEmergency()">
      ğŸš¨ TRIGGER EMERGENCY + AUTO-CALL
    </button>
    <button class="btn" style="width:100%;" onclick="closeEmergency()">Cancel</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ALERT PANEL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="alert-panel" id="alert-panel">
  <div class="alert-head">
    <span class="alert-head-title">â—ˆ ALERT LOG</span>
    <div style="display:flex;gap:.5rem;">
      <button class="btn" style="padding:.28rem .7rem;font-size:.56rem;" onclick="clearAlerts()">Clear</button>
      <button class="btn btn-danger" style="padding:.28rem .7rem;font-size:.56rem;" onclick="closeAlerts()">âœ•</button>
    </div>
  </div>
  <div class="alert-list" id="alert-list">
    <p style="font-family:var(--mono);font-size:.62rem;color:var(--muted);text-align:center;padding:2rem;">
      No alerts. Monitoring active.
    </p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• CHATBOT â•â•â•â•â•â•â•â•â•â•â• -->
<div class="chat-panel" id="chat-panel">
  <div class="chat-head">
    <span class="chat-head-title"><span class="pulse-dot"></span>AI HEALTH ASSISTANT</span>
    <button onclick="toggleChat()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;">âœ•</button>
  </div>
  <div class="chat-vitals-bar" id="chat-vitals-bar">Live vitals: connectingâ€¦</div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-msg bot">
      Hello! I'm your VitalSense AI assistant.<br>
      I can see your <strong>live streaming vitals</strong> in real time.<br>
      Ask me anything about your health data.
    </div>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" type="text"
           placeholder="Ask about your vitalsâ€¦"
           onkeydown="if(event.key==='Enter')sendChat()"/>
    <button class="chat-send" onclick="sendChat()">â–¶</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• FAB BUTTONS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="fab-group" id="fab-group">
  <button class="fab fab-emergency" onclick="openEmergency()" title="Emergency">ğŸš¨</button>
  <button class="fab fab-alert" onclick="openAlerts()" title="Alerts" style="position:relative;">
    ğŸ””<span class="ubadge" id="fab-badge"></span>
  </button>
  <button class="fab fab-chat" onclick="toggleChat()" title="AI Chatbot">ğŸ¤–</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cls(c){return c==='danger'?'danger':c==='warn'?'warn':'ok';}
function pillHtml(c,t){return `<span class="pill pill-${c}">${t}</span>`;}
function fillBar(el,pct,c){el.style.width=pct+'%';el.className='progress-fill fill-'+c;}
function cardCls(el,c){el.className='card'+(c==='danger'?' card-danger':c==='warn'?' card-warn':' card-ok');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer=null;
function showToast(msg,level='info'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast '+level+' show';
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),4500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SIMULATION (fallback when MJPEG not loading)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSimCanvas(canvas,label){
  const ctx=canvas.getContext('2d'),W=canvas.width||640,H=canvas.height||240;
  canvas.width=canvas.offsetWidth||W;
  ctx.fillStyle='#080d14';ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(0,40,60,.5)';ctx.lineWidth=1;
  for(let x=0;x<W;x+=52){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=52){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}
  const t=Date.now()/1000;
  ctx.beginPath();ctx.strokeStyle='rgba(0,200,240,.7)';ctx.lineWidth=2;
  ctx.shadowColor='rgba(0,200,240,.4)';ctx.shadowBlur=5;
  for(let i=0;i<W;i+=2){
    const ph=(i/W)*Math.PI*8+t*2,p=ph%(2*Math.PI);
    let v;
    if(p<.15)v=p/.15*48;else if(p<.25)v=48*(1-(p-.15)/.1);
    else if(p<.35)v=-12*(1-(p-.25)/.1);else v=Math.sin(ph)*5;
    if(i===0)ctx.moveTo(i,H*.6-v);else ctx.lineTo(i,H*.6-v);
  }
  ctx.stroke();ctx.shadowBlur=0;
  const cx=W/2,cy=H/2-10,r=55;
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle='rgba(0,200,240,.4)';ctx.lineWidth=1;ctx.stroke();
  const ls=10;
  [[cx-r,cy-r,1,1],[cx+r,cy-r,-1,1],[cx-r,cy+r,1,-1],[cx+r,cy+r,-1,-1]].forEach(([px,py,dx,dy])=>{
    ctx.beginPath();ctx.strokeStyle='#00ff9d';ctx.lineWidth=2;
    ctx.moveTo(px,py);ctx.lineTo(px+dx*ls,py);ctx.stroke();
    ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(px,py+dy*ls);ctx.stroke();
  });
  const sy=cy-r+((Date.now()/14)%(r*2));
  if(sy>cy-r&&sy<cy+r){
    ctx.beginPath();ctx.strokeStyle='rgba(0,212,255,.2)';ctx.lineWidth=1;
    ctx.moveTo(cx-r,sy);ctx.lineTo(cx+r,sy);ctx.stroke();
  }
  ctx.fillStyle='rgba(0,200,240,.8)';ctx.font='11px monospace';ctx.fillText(label,14,20);
  ctx.fillStyle='rgba(55,85,110,.8)';ctx.font='9px monospace';
  ctx.fillText('SIMULATION MODE',14,H-10);
}

let faceCanvasAnim=null,heartCanvasAnim=null;
function startCanvasAnim(canvasId,label,animRef){
  const c=document.getElementById(canvasId);
  if(!c) return null;
  let id=null;
  (function loop(){id=requestAnimationFrame(loop);drawSimCanvas(c,label);})();
  return id;
}
function stopAnim(id){if(id)cancelAnimationFrame(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘  MJPEG STREAM â€” attach src to <img>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let faceActive=false,heartActive=false;

function startFaceStream(){
  if(faceActive)return;faceActive=true;
  const img=document.getElementById('face-stream');
  const canvas=document.getElementById('face-canvas');
  // Start canvas anim immediately for visual feedback
  canvas.style.display='block';img.style.display='none';
  faceCanvasAnim=startCanvasAnim('face-canvas','FACE SCANNER',faceCanvasAnim);
  // Attach MJPEG src â€” browser will show it when it loads
  img.src='/stream/face?t='+Date.now();
  img.onload=()=>{
    canvas.style.display='none';img.style.display='block';
    stopAnim(faceCanvasAnim);faceCanvasAnim=null;
    document.getElementById('face-sim-badge').style.display='none';
  };
  img.onerror=()=>{
    canvas.style.display='block';img.style.display='none';
    document.getElementById('face-sim-badge').style.display='inline';
    if(!faceCanvasAnim) faceCanvasAnim=startCanvasAnim('face-canvas','FACE SCANNER',null);
  };
  // Poll metrics independently
  faceMetricInterval=setInterval(fetchFaceMetrics,1500);fetchFaceMetrics();
  document.getElementById('face-start-btn').disabled=true;
  document.getElementById('face-stop-btn').disabled=false;
}

function stopFaceStream(){
  faceActive=false;
  document.getElementById('face-stream').src='';
  stopAnim(faceCanvasAnim);faceCanvasAnim=null;
  clearInterval(faceMetricInterval);
  document.getElementById('face-start-btn').disabled=false;
  document.getElementById('face-stop-btn').disabled=true;
}

let faceMetricInterval=null;
async function fetchFaceMetrics(){
  try{
    const r=await fetch('/api/face/frame');const d=await r.json();
    document.getElementById('stress-val').textContent=d.stress+' / 100';
    fillBar(document.getElementById('stress-bar'),d.stress,cls(d.stress_cls));
    document.getElementById('stress-pill').innerHTML=pillHtml(d.stress_cls,d.stress>70?'âš  HIGH STRESS':d.stress>45?'â–³ MODERATE':'âœ“ NORMAL');
    cardCls(document.getElementById('stress-card'),d.stress_cls);
    document.getElementById('fatigue-val').textContent=d.fatigue+' / 100';
    fillBar(document.getElementById('fatigue-bar'),d.fatigue,cls(d.fatigue_cls));
    document.getElementById('fatigue-pill').innerHTML=pillHtml(d.fatigue_cls,d.fatigue>70?'âš  HIGH FATIGUE':d.fatigue>45?'â–³ MODERATE':'âœ“ NORMAL');
    cardCls(document.getElementById('fatigue-card'),d.fatigue_cls);
  }catch(e){}
}

function startHeartStream(){
  if(heartActive)return;heartActive=true;
  const img=document.getElementById('heart-stream');
  const canvas=document.getElementById('heart-canvas');
  canvas.style.display='block';img.style.display='none';
  heartCanvasAnim=startCanvasAnim('heart-canvas','HEART MONITOR',heartCanvasAnim);
  img.src='/stream/heart?t='+Date.now();
  img.onload=()=>{
    canvas.style.display='none';img.style.display='block';
    stopAnim(heartCanvasAnim);heartCanvasAnim=null;
    document.getElementById('heart-sim-badge').style.display='none';
  };
  img.onerror=()=>{
    canvas.style.display='block';img.style.display='none';
    document.getElementById('heart-sim-badge').style.display='inline';
    if(!heartCanvasAnim) heartCanvasAnim=startCanvasAnim('heart-canvas','HEART MONITOR',null);
  };
  document.getElementById('heart-start-btn').disabled=true;
  document.getElementById('heart-stop-btn').disabled=false;
}

function stopHeartStream(){
  heartActive=false;
  document.getElementById('heart-stream').src='';
  stopAnim(heartCanvasAnim);heartCanvasAnim=null;
  document.getElementById('heart-start-btn').disabled=false;
  document.getElementById('heart-stop-btn').disabled=true;
}

document.getElementById('face-start-btn').addEventListener('click',startFaceStream);
document.getElementById('face-stop-btn').addEventListener('click',stopFaceStream);
document.getElementById('heart-start-btn').addEventListener('click',startHeartStream);
document.getElementById('heart-stop-btn').addEventListener('click',stopHeartStream);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘  SSE VITALS STREAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sseSource=null,liveVitals={},unreadAlerts=0;
const hrHistory=[];
const chartCanvas=document.getElementById('hr-chart-canvas');
const chartCtx=chartCanvas.getContext('2d');

function connectSSE(){
  if(sseSource)sseSource.close();
  sseSource=new EventSource('/api/stream');

  sseSource.addEventListener('connected',()=>{
    document.getElementById('sse-dot').classList.add('live');
    document.getElementById('sse-label').textContent='SSE Live';
  });

  sseSource.addEventListener('vitals',e=>{
    const d=JSON.parse(e.data);liveVitals=d;
    updateChatVitalsBar(d);
    // Update heart module metrics (always, even if module not active â€” keeps data fresh)
    document.getElementById('hr-val').innerHTML=
      d.heart_rate+' <span style="font-size:1rem;color:var(--muted);">BPM</span>';
    document.getElementById('hr-val').className='metric-value large '+(d.at_risk?'danger':'');
    document.getElementById('hr-status').innerHTML=pillHtml(d.at_risk?'danger':'ok',
      d.at_risk?'âš  CARDIAC RISK DETECTED':'âœ“ NORMAL CONDITION');
    cardCls(document.getElementById('hr-card'),d.at_risk?'danger':'ok');
    document.getElementById('spo2-val').textContent=d.spo2+'%';
    document.getElementById('spo2-val').className='sv '+d.spo2_cls;
    document.getElementById('temp-val').textContent=d.temperature+'Â°C';
    document.getElementById('temp-val').className='sv '+d.temp_cls;
    document.getElementById('act-val').textContent=d.activity+'/10';
    document.getElementById('hrv-val').textContent=d.hrv+' ms';
    if(d.hr_history){hrHistory.length=0;d.hr_history.forEach(v=>hrHistory.push(v));drawChart();}
  });

  // â‘¡ AUTO-CALL on critical event
  sseSource.addEventListener('auto_call',e=>{
    const d=JSON.parse(e.data);
    const contact=d.contact||{};
    showAutocallBanner(contact,d.reason||'Emergency detected');
  });

  // â‘¡ Alert log
  sseSource.addEventListener('alert',e=>{
    const d=JSON.parse(e.data);
    addAlert(d);
    showToast(d.title,d.level==='critical'?'critical':d.level==='warning'?'warning':'info');
  });

  // â‘¢ Browser push notification
  sseSource.addEventListener('notification',e=>{
    const d=JSON.parse(e.data);
    showToast('ğŸ”” '+d.title,d.level||'info');
    if(Notification.permission==='granted'){
      const n=new Notification(d.title,{body:d.body,icon:'/favicon.ico',
        requireInteraction:d.urgent||false});
      if(d.urgent) setTimeout(()=>n.close(),8000);
    }
  });

  sseSource.addEventListener('alerts_cleared',()=>{
    document.getElementById('alert-list').innerHTML=
      '<p style="font-family:var(--mono);font-size:.62rem;color:var(--muted);text-align:center;padding:2rem;">Cleared.</p>';
    unreadAlerts=0;updateBadge();
  });

  sseSource.onerror=()=>{
    document.getElementById('sse-dot').classList.remove('live');
    document.getElementById('sse-label').textContent='Reconnectingâ€¦';
    setTimeout(connectSSE,3000);
  };
}
connectSSE();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HR CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawChart(){
  chartCanvas.width=chartCanvas.offsetWidth||700;
  const cw=chartCanvas.width,ch=130;chartCanvas.height=ch;
  chartCtx.clearRect(0,0,cw,ch);
  if(hrHistory.length<2)return;
  const mn=Math.min(...hrHistory)-5,mx=Math.max(...hrHistory)+5;
  const sy=v=>(ch-20)-(v-mn)/(mx-mn)*(ch-40)+10;
  const sx=i=>i/(hrHistory.length-1)*cw;
  chartCtx.strokeStyle='rgba(30,51,84,.5)';chartCtx.lineWidth=1;
  for(let y=0;y<=4;y++){const py=10+(ch-40)*y/4;chartCtx.beginPath();chartCtx.moveTo(0,py);chartCtx.lineTo(cw,py);chartCtx.stroke();}
  const g=chartCtx.createLinearGradient(0,0,0,ch);
  g.addColorStop(0,'rgba(0,212,255,.22)');g.addColorStop(1,'rgba(0,212,255,0)');
  chartCtx.beginPath();chartCtx.moveTo(sx(0),ch);
  hrHistory.forEach((v,i)=>chartCtx.lineTo(sx(i),sy(v)));
  chartCtx.lineTo(sx(hrHistory.length-1),ch);chartCtx.closePath();
  chartCtx.fillStyle=g;chartCtx.fill();
  chartCtx.beginPath();hrHistory.forEach((v,i)=>i===0?chartCtx.moveTo(sx(i),sy(v)):chartCtx.lineTo(sx(i),sy(v)));
  chartCtx.strokeStyle='#00d4ff';chartCtx.lineWidth=2;
  chartCtx.shadowColor='rgba(0,212,255,.4)';chartCtx.shadowBlur=5;chartCtx.stroke();chartCtx.shadowBlur=0;
  const last=hrHistory.length-1;
  chartCtx.beginPath();chartCtx.arc(sx(last),sy(hrHistory[last]),4,0,Math.PI*2);
  chartCtx.fillStyle='#00d4ff';chartCtx.fill();
}
window.addEventListener('resize',drawChart);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘¡ EMERGENCY + AUTO-CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEmergency(){document.getElementById('emergency-overlay').classList.add('open');}
function closeEmergency(){document.getElementById('emergency-overlay').classList.remove('open');}

async function manualEmergency(){
  closeEmergency();
  const r=await fetch('/api/emergency/trigger',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({reason:'Manual emergency trigger',vitals:liveVitals})
  });
  const d=await r.json();
  if(d.contact && d.contact.phone){
    showAutocallBanner(d.contact,'Manual emergency triggered');
  }
}

let autocallTimer=null;
function showAutocallBanner(contact,reason){
  const banner=document.getElementById('autocall-banner');
  const link=document.getElementById('autocall-link');
  const text=document.getElementById('autocall-text');
  text.textContent=`ğŸ“ Auto-calling ${contact.name||'Emergency Contact'} â€” ${reason}`;
  link.href='tel:'+(contact.phone||'108');
  banner.classList.add('show');
  document.getElementById('main-layout').style.marginTop='52px';
  // Auto-open phone dialer on mobile after short delay
  clearTimeout(autocallTimer);
  autocallTimer=setTimeout(()=>{
    if(contact.phone) window.location.href='tel:'+contact.phone;
  },1200);
}

function dismissAutocall(){
  clearTimeout(autocallTimer);
  document.getElementById('autocall-banner').classList.remove('show');
  document.getElementById('main-layout').style.marginTop='0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAlerts(){document.getElementById('alert-panel').classList.add('open');unreadAlerts=0;updateBadge();}
function closeAlerts(){document.getElementById('alert-panel').classList.remove('open');}

function addAlert(a){
  const list=document.getElementById('alert-list');
  const empty=list.querySelector('p');if(empty)empty.remove();
  const div=document.createElement('div');div.className='alert-item '+a.level;
  div.innerHTML=`<div class="a-time">${a.timestamp}</div><div class="a-title">${a.title}</div><div class="a-msg">${a.message}</div>`;
  list.prepend(div);unreadAlerts++;updateBadge();
  const items=list.querySelectorAll('.alert-item');
  if(items.length>25)items[items.length-1].remove();
}

function updateBadge(){
  ['sidebar-badge','fab-badge'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    if(unreadAlerts>0){el.textContent=unreadAlerts>9?'9+':unreadAlerts;el.classList.add('show');}
    else el.classList.remove('show');
  });
}

async function clearAlerts(){
  await fetch('/api/alerts/clear',{method:'POST'});
}

// Load existing alerts
(async()=>{try{const r=await fetch('/api/alerts');const d=await r.json();d.alerts.forEach(a=>addAlert(a));}catch(e){}})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘¢ NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('Notification' in window && Notification.permission==='default'){
  Notification.requestPermission().then(p=>{
    if(p==='granted') showToast('âœ“ Notifications enabled','info');
  });
}
async function testNotif(){
  await fetch('/api/notifications/test',{method:'POST'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VOICE RECORDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('record-btn').addEventListener('click',async()=>{
  const btn=document.getElementById('record-btn');const dur=parseInt(document.getElementById('dur-slider').value);
  const status=document.getElementById('rec-status');
  btn.disabled=true;
  status.innerHTML=`<div class="card card-warn" style="padding:.7rem 1rem;">
    <span class="pulse-dot"></span><span style="font-family:var(--mono);font-size:.68rem;color:var(--warn);">RECORDINGâ€¦ ${dur}s</span></div>`;
  try{
    const r=await fetch('/api/voice/record',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({duration:dur})});
    const d=await r.json();
    status.innerHTML='';
    document.getElementById('voice-results').style.display='block';
    ['anxiety','asthma'].forEach(k=>{
      document.getElementById(k+'-val').textContent=d[k]+'%';
      fillBar(document.getElementById(k+'-bar'),d[k],cls(d[k+'_cls']));
      document.getElementById(k+'-pill').innerHTML=pillHtml(d[k+'_cls'],d[k+'_lbl']);
      cardCls(document.getElementById(k+'-card'),d[k+'_cls']);
    });
  }catch(e){status.innerHTML='<span class="pill pill-danger">Recording failed</span>';}
  btn.disabled=false;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEATMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async()=>{
  try{
    const r=await fetch('/api/correlation');const d=await r.json();
    const cols=d.columns,mat=d.matrix;
    function hc(v){return v>0?`rgba(0,${Math.round(212*(1-v)+255*v)},${Math.round(255*(1-v)+157*v)},${.15+v*.5})`:`rgba(255,69,96,${.1+(-v)*.4})`;}
    let h='<table class="heatmap"><thead><tr><th></th>';
    cols.forEach(c=>h+=`<th>${c}</th>`);h+='</tr></thead><tbody>';
    mat.forEach((row,i)=>{
      h+=`<tr><th style="text-align:left;padding-right:10px;color:var(--muted);">${cols[i]}</th>`;
      row.forEach(v=>h+=`<td style="background:${hc(v)};">${v===1?'1.00':v.toFixed(2)}</td>`);
      h+='</tr>';
    });
    h+='</tbody></table>';
    document.getElementById('heatmap-wrap').innerHTML=h;
  }catch(e){document.getElementById('heatmap-wrap').innerHTML='<p style="font-family:var(--mono);font-size:.62rem;color:var(--muted);">Could not load.</p>';}
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â‘£ CHATBOT WITH LIVE VITALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chatHistory=[],chatOpen=false;

function toggleChat(){
  chatOpen=!chatOpen;
  document.getElementById('chat-panel').classList.toggle('open',chatOpen);
  document.getElementById('fab-group').style.display=chatOpen?'none':'flex';
  if(chatOpen)document.getElementById('chat-input').focus();
}

function updateChatVitalsBar(v){
  const bar=document.getElementById('chat-vitals-bar');
  bar.textContent=`Live: HR=${v.heart_rate}bpm  SpOâ‚‚=${v.spo2}%  Temp=${v.temperature}Â°C  Risk=${v.at_risk?'âš YES':'âœ“NO'}`;
  bar.style.color=v.at_risk?'var(--danger)':'var(--muted)';
}

async function sendChat(){
  const input=document.getElementById('chat-input');
  const msg=input.value.trim();if(!msg)return;
  input.value='';appendChat(msg,'user');
  chatHistory.push({role:'user',content:msg});

  const tid='t'+Date.now();
  const typing=document.createElement('div');
  typing.className='chat-msg bot typing';typing.id=tid;typing.textContent='â— â— â—';
  document.getElementById('chat-messages').appendChild(typing);
  document.getElementById('chat-messages').scrollTop=9999;

  try{
    const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:msg,history:chatHistory.slice(-8)})});
    const d=await r.json();
    document.getElementById(tid)?.remove();
    const reply=d.reply||'Sorry, no response.';
    appendChat(reply,'bot');
    chatHistory.push({role:'assistant',content:reply});
    if(chatHistory.length>20)chatHistory=chatHistory.slice(-20);
    // Refresh vitals bar if vitals returned
    if(d.vitals && Object.keys(d.vitals).length) updateChatVitalsBar(d.vitals);
  }catch(e){
    document.getElementById(tid)?.remove();
    appendChat('Connection error. Please try again.','bot');
  }
}

function appendChat(text,role){
  const msgs=document.getElementById('chat-messages');
  const div=document.createElement('div');div.className='chat-msg '+role;
  div.innerHTML=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
  msgs.appendChild(div);msgs.scrollTop=9999;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-START active module
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const activeModule='{{ module }}';
if(activeModule==='face')  startFaceStream();
if(activeModule==='heart') startHeartStream();
</script>
</body>
</html>
